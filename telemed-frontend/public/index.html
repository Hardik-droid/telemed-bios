<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MyHealth â€“ Affordable Care for Everyone</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;700&family=Noto+Sans+Gurmukhi:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    .shadow-custom { box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    #videoGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
    video { width: 100%; border-radius: 1rem; background: #000; }
    body.hi, body.pa { font-family: 'Noto Sans Devanagari', 'Noto Sans Gurmukhi', system-ui, sans-serif; }
    
    /* SOS Emergency Styles */
    .sos-container {
      width: 100%;
      max-width: 500px;
      background-color: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      animation: fadeIn 0.8s ease-out;
    }
    
    .sos-header {
      background: linear-gradient(to right, #2c7fb8, #1d5f8a);
      color: white;
      padding: 25px 20px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .sos-header::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
    }
    
    .sos-countdown {
      font-size: 80px;
      font-weight: bold;
      color: #e74c3c;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
      margin: 20px 0;
      animation: pulseCount 1s infinite;
    }
    
    .dispatch-notice {
      text-align: center;
      font-weight: 700;
      color: #2ecc71;
      font-size: 1.05rem;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 600ms ease-out forwards;
    }
    
    @keyframes pulseCount {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .dispatch-animation {
      display: inline-block;
      margin-left: 10px;
      animation: blink 1.5s infinite;
    }
    
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
    
    .eta-display {
      font-size: 18px;
      margin-top: 10px;
      color: #2c3e50;
      font-weight: bold;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

  <script src="/socket.io/socket.io.js"></script>

  <!-- LANGUAGE SELECTION SCREEN -->
  <div id="languageScreen" class="flex items-center justify-center min-h-screen p-6">
    <div class="bg-white rounded-3xl shadow-2xl p-12 max-w-md w-full text-center">
      <div class="flex items-center justify-center mb-8">
        <i class="fas fa-heartbeat text-red-500 text-5xl mr-3"></i>
        <div>
          <h1 class="text-3xl font-bold text-gray-800">MyHealth</h1>
          <p class="text-sm text-gray-500">Affordable Care for Everyone</p>
        </div>
      </div>
      <h2 class="text-2xl font-semibold mb-10" data-t="selectLanguage">Select your preferred language</h2>
      <div class="space-y-4">
        <button onclick="setLanguage('en')" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-5 rounded-2xl text-xl transition transform hover:scale-105">English</button>
        <button onclick="setLanguage('hi')" class="w-full bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-bold py-5 rounded-2xl text-xl transition transform hover:scale-105">à¤¹à¤¿à¤‚à¤¦à¥€</button>
        <button onclick="setLanguage('pa')" class="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-bold py-5 rounded-2xl text-xl transition transform hover:scale-105">à¨ªà©°à¨œà¨¾à¨¬à©€</button>
      </div>
      <div class="mt-8">
        <span class="bg-green-100 text-green-700 px-4 py-2 rounded-full text-sm font-medium inline-flex items-center">
          <i class="fas fa-circle text-green-500 mr-2"></i>
          <span data-t="systemOnline">System Online</span>
        </span>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="app" class="hidden">

    <!-- BIOMETRIC LOGIN SCREEN -->
    <div id="biometricScreen" class="flex items-center justify-center min-h-screen p-6">
      <div class="bg-white rounded-3xl shadow-2xl p-12 max-w-md w-full text-center">
        <i class="fas fa-fingerprint text-8xl text-purple-600 mb-8"></i>
        <h1 class="text-3xl font-bold text-gray-800 mb-4" data-t="welcomeUser">Welcome Back, Hardik</h1>
        <p class="text-gray-600 mb-10" data-t="touchSensor">Touch the sensor or use Face ID to continue</p>
        <button id="fingerprintBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold text-xl py-6 px-12 rounded-2xl shadow-lg transform transition hover:scale-105">
          <i class="fas fa-fingerprint mr-3"></i>
          <span data-t="authenticate">Authenticate with Biometric</span>
        </button>
        <div id="status" class="mt-8 text-lg font-medium"></div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden bg-white min-h-screen">
      <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
          <div class="flex items-center space-x-3">
            <i class="fas fa-heartbeat text-red-500 text-3xl"></i>
            <div>
              <h1 class="text-2xl font-bold text-gray-800">MyHealth</h1>
              <p class="text-sm text-gray-500">Affordable Care for Everyone</p>
            </div>
          </div>
          <span class="bg-green-100 text-green-700 px-4 py-3 rounded-full text-sm font-medium flex items-center">
            <i class="fas fa-circle text-green-500 mr-2"></i> <span data-t="systemOnline">System Online</span>
          </span>
        </div>
      </header>

      <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-2">Hello, Hardik Jain</h2>
        <p class="text-gray-600 mb-8" data-t="howCanWeHelp">How can we help you today?</p>

        <div class="mb-10">
          <button onclick="triggerSOS()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-6 rounded-2xl text-xl shadow-lg transition transform hover:scale-105 flex items-center justify-center space-x-3">
            <i class="fas fa-ambulance"></i>
            <span data-t="sos">SOS Emergency</span>
          </button>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
          <button onclick="openTranscriber()" class="bg-blue-500 hover:bg-blue-600 text-white rounded-2xl p-8 shadow-custom transition transform hover:scale-105 relative">
            <i class="fas fa-microphone text-5xl mb-4"></i>
            <p class="text-lg font-semibold" data-t="recordSymptoms">Record Your Symptoms</p>
          </button>

          <button onclick="startVideoCall()" class="bg-white hover:bg-gray-50 rounded-2xl p-8 shadow-custom border border-gray-100 transition transform hover:scale-105 relative">
            <i class="fas fa-video text-blue-500 text-4xl mb-4"></i>
            <p class="text-lg font-semibold mt-4" data-t="videoCall">Quick Video Call</p>
            <span class="absolute top-4 right-4 bg-green-500 text-white text-xs px-2 py-1 rounded-full animate-pulse">LIVE</span>
          </button>

          <button class="bg-white hover:bg-gray-50 rounded-2xl p-8 shadow-custom border border-gray-100 transition transform hover:scale-105">
            <i class="fas fa-file-medical text-green-500 text-4xl mb-4"></i>
            <p class="text-lg font-semibold mt-4" data-t="healthRecords">My Health Records</p>
          </button>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <button class="bg-white rounded-2xl p-8 shadow-custom border border-gray-100 text-center transition transform hover:scale-105">
            <i class="fas fa-heartbeat text-red-500 text-5xl mb-4"></i>
            <p class="text-lg font-semibold" data-t="measureBP">Measure BP</p>
          </button>
          <button class="bg-white rounded-2xl p-8 shadow-custom border border-gray-100 text-center transition transform hover:scale-105">
            <i class="fas fa-tint text-purple-500 text-5xl mb-4"></i>
            <p class="text-lg font-semibold" data-t="sugarTest">Sugar Test</p>
          </button>
        </div>
      </main>
    </div>

    <!-- SOS EMERGENCY MODAL -->
    <div id="sosModal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
      <div class="sos-container">
        <div class="sos-header">
          <div class="flex items-center justify-center mb-4">
            <i class="fas fa-heartbeat text-white text-5xl mr-3"></i>
            <div>
              <h1 class="text-3xl font-bold text-white">MyHealth</h1>
              <p class="text-sm text-white opacity-90">Affordable Care for Everyone</p>
            </div>
          </div>
        </div>
        
        <div class="bg-gray-50 p-4 text-center border-b">
          <div class="bg-green-100 text-green-700 px-4 py-2 rounded-full text-sm font-medium inline-flex items-center">
            <i class="fas fa-circle text-green-500 mr-2"></i>
            <span data-t="systemOnline">System Online</span>
          </div>
        </div>
        
        <div class="bg-blue-50 p-8 text-center">
          <div class="sos-countdown" id="countdown">5</div>
          <p class="text-gray-700">Ambulance will be dispatched in</p>
        </div>
        
        <div class="bg-gray-100 p-6 text-center text-xl font-medium text-gray-800 border-t border-b border-gray-200">
          <div id="dispatchMessage">
            Dispatching nearest unit<span class="dispatch-animation">...</span>
          </div>
        </div>
        
        <div class="p-6 bg-white">
          <div class="text-center mb-4">
            <p>Ambulance from: <strong id="hospitalName">Metro Medical Center</strong></p>
            <p>Distance: <strong id="distance">9.4</strong> km</p>
            <p class="eta-display">Estimated arrival: <strong id="eta">8-15</strong> minutes</p>
            <p>Driver: <strong>Happy From Bihar</strong> | Contact: <strong>7549934864</strong></p>
          </div>
          <button id="emergencyReceived" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl text-lg transition">
            Emergency Received
          </button>
        </div>
      </div>
    </div>

    <!-- Voice Transcriber Modal -->
    <div id="voiceModal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl h-[80vh] flex flex-col">
        <div class="p-6 border-b flex justify-between items-center">
          <h3 class="text-2xl font-bold" data-t="liveTranscription">Live Voice Transcription</h3>
          <button onclick="closeTranscriber()" class="text-red-600 hover:text-red-800 text-3xl">Ã—</button>
        </div>
        <div class="flex-1 p-6 overflow-y-auto flex flex-col">
          <p class="text-sm text-gray-500 mb-4" data-t="langNote">The transcriber automatically uses your selected language.</p>
          <div class="flex justify-center space-x-4 mb-4">
            <button id="startButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg" data-t="startListening">Start Listening</button>
            <button id="stopButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg" disabled data-t="stop">Stop</button>
          </div>
          <div id="status" class="text-center text-sm font-medium h-6 mb-4 text-gray-600">Awaiting Command</div>
          <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 bg-gray-50 min-h-[150px] overflow-auto flex-1">
            <h4 class="text-md font-semibold text-gray-700 mb-2" data-t="transcription">Transcription:</h4>
            <p id="outputArea" class="text-gray-800 whitespace-pre-wrap"></p>
          </div>
          <div class="mt-4 flex justify-center space-x-4">
            <button id="copyBtn" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-lg" data-t="copyText">Copy Text</button>
            <button id="saveBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg" data-t="saveToRecords">Save To Records</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Video Call Modal -->
    <div id="videoCallModal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col">
        <div class="p-4 border-b flex justify-between items-center">
          <h3 class="text-xl font-bold" data-t="videoConsultation">Video Consultation <span class="text-green-500">Live</span></h3>
          <button onclick="endCall()" class="text-red-500 hover:text-red-700 text-3xl">Ã—</button>
        </div>
        <div id="videoGrid" class="flex-1 p-4 overflow-hidden"></div>
        <div class="p-4 border-t flex justify-center space-x-8">
          <button onclick="toggleMic()" class="bg-gray-700 hover:bg-gray-800 text-white p-5 rounded-full"><i id="micIconVideo" class="fas fa-microphone text-2xl"></i></button>
          <button onclick="endCall()" class="bg-red-600 hover:bg-red-700 text-white p-7 rounded-full"><i class="fas fa-phone-slash text-2xl"></i></button>
          <button onclick="toggleCamera()" class="bg-gray-700 hover:bg-gray-800 text-white p-5 rounded-full"><i id="camIcon" class="fas fa-video text-2xl"></i></button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // TRANSLATIONS
    const translations = {
      en: { 
        selectLanguage: "Select your preferred language", 
        systemOnline: "System Online", 
        welcomeUser: "Welcome Back, Hardik", 
        touchSensor: "Touch the sensor or use Face ID to continue", 
        authenticate: "Authenticate with Biometric", 
        howCanWeHelp: "How can we help you today?", 
        sos: "SOS Emergency", 
        recordSymptoms: "Record Your Symptoms", 
        videoCall: "Quick Video Call", 
        healthRecords: "My Health Records", 
        measureBP: "Measure BP", 
        sugarTest: "Sugar Test", 
        liveTranscription: "Live Voice Transcription", 
        langNote: "The transcriber automatically uses your selected language.", 
        startListening: "Start Listening", 
        stop: "Stop", 
        transcription: "Transcription:", 
        copyText: "Copy Text", 
        saveToRecords: "Save To Records", 
        videoConsultation: "Video Consultation" 
      },
      hi: { 
        selectLanguage: "à¤…à¤ªà¤¨à¥€ à¤ªà¤¸à¤‚à¤¦à¥€à¤¦à¤¾ à¤­à¤¾à¤·à¤¾ à¤šà¥à¤¨à¥‡à¤‚", 
        systemOnline: "à¤¸à¤¿à¤¸à¥à¤Ÿà¤® à¤‘à¤¨à¤²à¤¾à¤‡à¤¨", 
        welcomeUser: "à¤µà¤¾à¤ªà¤¸ à¤¸à¥à¤µà¤¾à¤—à¤¤ à¤¹à¥ˆ, à¤¹à¤¾à¤°à¥à¤¦à¤¿à¤•", 
        touchSensor: "à¤¸à¥‡à¤‚à¤¸à¤° à¤›à¥à¤à¤‚ à¤¯à¤¾ à¤«à¥‡à¤¸ à¤†à¤ˆà¤¡à¥€ à¤•à¤¾ à¤‰à¤ªà¤¯à¥‹à¤— à¤•à¤°à¥‡à¤‚", 
        authenticate: "à¤¬à¤¾à¤¯à¥‹à¤®à¥‡à¤Ÿà¥à¤°à¤¿à¤• à¤¸à¥‡ à¤ªà¥à¤°à¤®à¤¾à¤£à¤¿à¤¤ à¤•à¤°à¥‡à¤‚", 
        howCanWeHelp: "à¤†à¤œ à¤¹à¤® à¤†à¤ªà¤•à¥€ à¤•à¥ˆà¤¸à¥‡ à¤®à¤¦à¤¦ à¤•à¤° à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚?", 
        sos: "à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ SOS", 
        recordSymptoms: "à¤…à¤ªà¤¨à¥‡ à¤²à¤•à¥à¤·à¤£ à¤°à¤¿à¤•à¥‰à¤°à¥à¤¡ à¤•à¤°à¥‡à¤‚", 
        videoCall: "à¤¤à¥à¤°à¤‚à¤¤ à¤µà¥€à¤¡à¤¿à¤¯à¥‹ à¤•à¥‰à¤²", 
        healthRecords: "à¤®à¥‡à¤°à¥‡ à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤°à¤¿à¤•à¥‰à¤°à¥à¤¡", 
        measureBP: "à¤¬à¥€à¤ªà¥€ à¤®à¤¾à¤ªà¥‡à¤‚", 
        sugarTest: "à¤¶à¥à¤—à¤° à¤Ÿà¥‡à¤¸à¥à¤Ÿ", 
        liveTranscription: "à¤²à¤¾à¤‡à¤µ à¤µà¥‰à¤‡à¤¸ à¤Ÿà¥à¤°à¤¾à¤‚à¤¸à¤•à¥à¤°à¤¿à¤ªà¥à¤¶à¤¨", 
        langNote: "à¤Ÿà¥à¤°à¤¾à¤‚à¤¸à¤•à¥à¤°à¤¾à¤‡à¤¬à¤° à¤†à¤ªà¤•à¥€ à¤šà¥à¤¨à¥€ à¤¹à¥à¤ˆ à¤­à¤¾à¤·à¤¾ à¤•à¤¾ à¤‰à¤ªà¤¯à¥‹à¤— à¤•à¤°à¤¤à¤¾ à¤¹à¥ˆà¥¤", 
        startListening: "à¤¸à¥à¤¨à¤¨à¤¾ à¤¶à¥à¤°à¥‚ à¤•à¤°à¥‡à¤‚", 
        stop: "à¤°à¥à¤•à¥‡à¤‚", 
        transcription: "à¤Ÿà¥à¤°à¤¾à¤‚à¤¸à¤•à¥à¤°à¤¿à¤ªà¥à¤¶à¤¨:", 
        copyText: "à¤Ÿà¥‡à¤•à¥à¤¸à¥à¤Ÿ à¤•à¥‰à¤ªà¥€ à¤•à¤°à¥‡à¤‚", 
        saveToRecords: "à¤°à¤¿à¤•à¥‰à¤°à¥à¤¡ à¤®à¥‡à¤‚ à¤¸à¥‡à¤µ à¤•à¤°à¥‡à¤‚", 
        videoConsultation: "à¤µà¥€à¤¡à¤¿à¤¯à¥‹ à¤ªà¤°à¤¾à¤®à¤°à¥à¤¶" 
      },
      pa: { 
        selectLanguage: "à¨†à¨ªà¨£à©€ à¨ªà¤¸à©°à¨¦à©€à¨¦à¨¾ à¨­à¨¾à¨¸à¨¼à¨¾ à¨šà©à¨£à©‹", 
        systemOnline: "à¨¸à¨¿à¨¸à¨Ÿà¨® à¨†à¨¨à¨²à¨¾à¨ˆà¨¨", 
        welcomeUser: "à¨µà¨¾à¨ªà¨¸ à¨¸à¨µà¨¾à¨—à¨¤ à¨¹à©ˆ, à¨¹à¨¾à¨°à¨¦à¨¿à¨•", 
        touchSensor: "à¨¸à©ˆà¨‚à¨¸à¨° à¨¨à©‚à©° à¨›à©‚à¨¹à©‹ à¨œà¨¾à¨‚ à¨«à©‡à¨¸ à¨†à¨ˆà¨¡à©€ à¨µà¨°à¨¤à©‹à¨‚", 
        authenticate: "à¨¬à¨¾à¨‡à¨“à¨®à©ˆà¨Ÿà©à¨°à¨¿à¨• à¨¨à¨¾à¨² à¨ªà©à¨°à¨®à¨¾à¨£à¨¿à¨¤ à¨•à¨°à©‹", 
        howCanWeHelp: "à¨…à¨¸à©€à¨‚ à¨¤à©à¨¹à¨¾à¨¡à©€ à¨…à©±à¨œ à¨•à¨¿à¨µà©‡à¨‚ à¨®à¨¦à¨¦ à¨•à¨° à¨¸à¨•à¨¦à©‡ à¨¹à¨¾à¨‚?", 
        sos: "SOS à¨à¨®à¨°à¨œà©ˆà¨‚à¨¸à©€", 
        recordSymptoms: "à¨†à¨ªà¨£à©‡ à¨²à©±à¨›à¨£ à¨°à¨¿à¨•à¨¾à¨°à¨¡ à¨•à¨°à©‹", 
        videoCall: "à¨¤à©à¨°à©°à¨¤ à¨µà©€à¨¡à©€à¨“ à¨•à¨¾à¨²", 
        healthRecords: "à¨®à©‡à¨°à©‡ à¨¸à¨¿à¨¹à¨¤ à¨°à¨¿à¨•à¨¾à¨°à¨¡", 
        measureBP: "à¨¬à©€.à¨ªà©€. à¨®à¨¾à¨ªà©‹", 
        sugarTest: "à¨¸à¨¼à©‚à¨—à¨° à¨Ÿà©ˆà¨¸à¨Ÿ", 
        liveTranscription: "à¨²à¨¾à¨ˆà¨µ à¨µà©Œà¨‡à¨¸ à¨Ÿà©à¨°à¨¾à¨‚à¨¸à¨•à©à¨°à¨¿à¨ªà¨¸à¨¼à¨¨", 
        langNote: "à¨Ÿà©à¨°à¨¾à¨‚à¨¸à¨•à©à¨°à¨¾à¨ˆà¨¬à¨° à¨†à¨ªà¨£à©€ à¨šà©à¨£à©€ à¨­à¨¾à¨¸à¨¼à¨¾ à¨µà¨°à¨¤à¨¦à¨¾ à¨¹à©ˆà¥¤", 
        startListening: "à¨¸à©à¨£à¨¨à¨¾ à¨¸à¨¼à©à¨°à©‚ à¨•à¨°à©‹", 
        stop: "à¨°à©‹à¨•à©‹", 
        transcription: "à¨Ÿà©à¨°à¨¾à¨‚à¨¸à¨•à©à¨°à¨¿à¨ªà¨¸à¨¼à¨¨:", 
        copyText: "à¨Ÿà©ˆà¨•à¨¸à¨Ÿ à¨•à¨¾à¨ªà©€ à¨•à¨°à©‹", 
        saveToRecords: "à¨°à¨¿à¨•à¨¾à¨°à¨¡ à¨µà¨¿à©±à¨š à¨¸à©‡à¨µ à¨•à¨°à©‹", 
        videoConsultation: "à¨µà©€à¨¡à©€à¨“ à¨¸à¨²à¨¾à¨¹" 
      }
    };

    function t(key) {
      const lang = localStorage.getItem('lang') || 'en';
      return translations[lang][key] || translations.en[key] || key;
    }

    function applyTranslations() {
      document.querySelectorAll('[data-t]').forEach(el => el.textContent = t(el.getAttribute('data-t')));
      document.documentElement.lang = localStorage.getItem('lang') || 'en';
      document.body.className = document.body.className.replace(/\b(hi|pa|en)\b/g, '').trim() + ' ' + (localStorage.getItem('lang') || 'en');
    }

    function setLanguage(lang) {
      localStorage.setItem('lang', lang);
      const langScreen = document.getElementById('languageScreen');
      if (langScreen) langScreen.remove();
      const appEl = document.getElementById('app');
      if (appEl) appEl.classList.remove('hidden');
      applyTranslations();
      setTimeout(() => document.getElementById('fingerprintBtn')?.click(), 800);
    }

    window.addEventListener('load', () => {
      const saved = localStorage.getItem('lang');
      if (saved && ['en','hi','pa'].includes(saved)) {
        const langScreen = document.getElementById('languageScreen');
        if (langScreen) langScreen.remove();
        const appEl = document.getElementById('app');
        if (appEl) appEl.classList.remove('hidden');
        applyTranslations();
        setTimeout(() => document.getElementById('fingerprintBtn')?.click(), 600);
      }
    });

    // BIOMETRIC LOGIN
    document.getElementById('fingerprintBtn')?.addEventListener('click', async () => {
      const status = document.getElementById('status');
      status.innerHTML = "<span class='text-blue-600'>Authenticating...</span>";
      if (window.PublicKeyCredential) {
        try { 
          await navigator.credentials.get({ 
            publicKey: { 
              challenge: new Uint8Array(32), 
              userVerification: "required" 
            }
          }); 
          loginSuccess(); 
        } catch { 
          setTimeout(loginSuccess, 1000); 
        }
      } else {
        setTimeout(loginSuccess, 1200);
      }
    });

    function loginSuccess() {
      const statusEl = document.getElementById('status');
      if (statusEl) statusEl.innerHTML = "<span class='text-green-600'>Login Successful!</span>";
      setTimeout(() => {
        const bio = document.getElementById('biometricScreen');
        if (bio) {
          bio.style.transition = 'opacity 0.6s';
          bio.style.opacity = '0';
          setTimeout(() => { 
            bio.remove(); 
            const dash = document.getElementById('dashboard'); 
            if (dash) dash.classList.remove('hidden'); 
          }, 600);
        } else {
          const dash = document.getElementById('dashboard'); 
          if (dash) dash.classList.remove('hidden');
        }
      }, 800);
    }

    // SOS EMERGENCY FUNCTIONALITY
    let sosCountdown;
    let sosCountdownValue = 5;
    
    function triggerSOS() {
      // Show SOS modal
      document.getElementById('sosModal').classList.remove('hidden');
      
      // Reset countdown
      sosCountdownValue = 5;
      document.getElementById('countdown').textContent = sosCountdownValue;
      document.getElementById('countdown').style.color = "#e74c3c";
      
      // Reset dispatch message
      document.getElementById('dispatchMessage').innerHTML = 
        "Dispatching nearest unit<span class='dispatch-animation'>...</span>";
      
      // Start countdown
      sosCountdown = setInterval(() => {
        sosCountdownValue--;
        document.getElementById('countdown').textContent = sosCountdownValue;
        
        if (sosCountdownValue <= 0) {
          clearInterval(sosCountdown);
          dispatchAmbulance();
        }
      }, 1000);
    }
    
    function dispatchAmbulance() {
      document.getElementById('countdown').textContent = "0";
      document.getElementById('countdown').style.color = "#2ecc71";
      
      // Update dispatch message
      document.getElementById('dispatchMessage').innerHTML = 
        "<div class='dispatch-notice'>Ambulance dispatched! <span style='color:#2ecc71;'>âœ“</span></div>";
    }
    
    function closeSOS() {
      clearInterval(sosCountdown);
      document.getElementById('sosModal').classList.add('hidden');
    }
    
    // Emergency Received button
    document.getElementById('emergencyReceived')?.addEventListener('click', function() {
      alert('Thank you for using MyHealth. We hope the patient recovers quickly.');
      closeSOS();
    });

    // VOICE TRANSCRIPTION
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const outputArea = document.getElementById('outputArea');
    const statusDiv = document.getElementById('status');
    let finalTranscript = '', isListening = false;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = SpeechRecognition ? new SpeechRecognition() : null;

    if (recognition) {
      recognition.continuous = true; 
      recognition.interimResults = true;
      recognition.onresult = e => {
        let interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const t = e.results[i][0].transcript;
          if (e.results[i].isFinal) finalTranscript += t + '.\n';
          else interim += t;
        }
        outputArea.textContent = finalTranscript + interim;
      };
      recognition.onstart = () => { 
        statusDiv.textContent = 'Listening...'; 
        startButton.disabled = true; 
        stopButton.disabled = false; 
      };
      recognition.onend = () => { 
        if (isListening) setTimeout(() => recognition.start(), 300); 
        else { 
          startButton.disabled = false; 
          stopButton.disabled = true; 
        } 
      };
      recognition.onerror = e => { 
        statusDiv.textContent = 'Error: ' + e.error; 
        isListening = false; 
        startButton.disabled = false; 
        stopButton.disabled = true; 
      };
    }

    function startRecognition() { 
      if (recognition) { 
        recognition.lang = localStorage.getItem('lang') === 'hi' ? 'hi-IN' : 
                          localStorage.getItem('lang') === 'pa' ? 'pa-IN' : 'en-US'; 
        recognition.start(); 
        isListening = true; 
      } 
    }
    
    function stopRecognition() { 
      isListening = false; 
      if (recognition) recognition.stop(); 
    }

    function openTranscriber() { 
      document.getElementById('voiceModal').classList.remove('hidden'); 
      setTimeout(startRecognition, 500); 
    }
    
    function closeTranscriber() { 
      stopRecognition(); 
      document.getElementById('voiceModal').classList.add('hidden'); 
    }

    document.getElementById('copyBtn')?.addEventListener('click', () => 
      navigator.clipboard.writeText(outputArea.textContent).then(() => alert('Copied!'))
    );
    
    document.getElementById('saveBtn')?.addEventListener('click', () => 
      alert('Saved to records!')
    );

    startButton?.addEventListener('click', startRecognition);
    stopButton?.addEventListener('click', stopRecognition);

    // VIDEO CALL
    let peer = null, currentCall = null, localStream = null;
    let patientPeerConnection = null;
    let patientSocket = null; // socket for patient side
    const videoGrid = document.getElementById('videoGrid');

    async function startVideoCall() {
      document.getElementById('videoCallModal').classList.remove('hidden');

      // initialize socket for patient
      patientSocket = io();

      // get local media
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

      // clear previous videos and add local + remote placeholders
      videoGrid.innerHTML = '';
      addVideoStream('localVideo', localStream, true);
      // create an empty remote placeholder stream (will be replaced ontrack)
      const placeholder = new MediaStream();
      addVideoStream('remoteVideo', placeholder, false);

      // create RTCPeerConnection
      patientPeerConnection = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      // add local tracks
      localStream.getTracks().forEach(track => patientPeerConnection.addTrack(track, localStream));

      // when remote track arrives, attach to remote video element
      patientPeerConnection.ontrack = (e) => {
        const remoteVideo = document.getElementById('remoteVideo');
        if (remoteVideo) remoteVideo.srcObject = e.streams[0];
      };

      // send ICE candidates to server
      patientPeerConnection.onicecandidate = (e) => {
        if (e.candidate && patientSocket) {
          patientSocket.emit('icecandidate', e.candidate);
        }
      };

      // create offer and send to server
      const offer = await patientPeerConnection.createOffer();
      await patientPeerConnection.setLocalDescription(offer);

      patientSocket.emit('offer', {
        from: 'Hardik',
        offer: JSON.stringify(patientPeerConnection.localDescription)
      });

      // listen for doctor's answer
      patientSocket.on('answer', async ({ answer }) => {
        await patientPeerConnection.setRemoteDescription(JSON.parse(answer));
      });

      // listen for remote ICE candidates
      patientSocket.on('icecandidate', (candidate) => {
        if (patientPeerConnection) patientPeerConnection.addIceCandidate(new RTCIceCandidate(candidate));
      });

      patientSocket.on('call-ended', () => {
        endCall();
      });
    }

    function addVideoStream(id, stream, isLocal = false) {
      const video = document.createElement('video');
      video.id = id; 
      video.srcObject = stream; 
      video.autoplay = true; 
      video.playsInline = true; 
      video.muted = isLocal;
      if (isLocal) video.classList.add('border-4', 'border-blue-500');
      video.classList.add('rounded-xl');
      videoGrid.appendChild(video);
    }

    function toggleMic() { 
      if (localStream) { 
        const enabled = localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled; 
        document.getElementById('micIconVideo').classList.toggle('fa-microphone-slash', !enabled); 
      } 
    }
    
    function toggleCamera() { 
      if (localStream) { 
        const enabled = localStream.getVideoTracks()[0].enabled = !localStream.getVideoTracks()[0].enabled; 
        document.getElementById('camIcon').classList.toggle('fa-video-slash', !enabled); 
      } 
    }
    
    function endCall() { 
      // close PeerJS call if present
      if (currentCall) currentCall.close(); 

      // close patient RTCPeerConnection if present
      if (patientPeerConnection) {
        try { patientPeerConnection.close(); } catch(e){}
        patientPeerConnection = null;
      }

      // stop local media tracks
      if (localStream) localStream.getTracks().forEach(t => t.stop()); 
      localStream = null;

      // clear video elements and hide modal
      videoGrid.innerHTML = ''; 
      document.getElementById('videoCallModal').classList.add('hidden'); 

      // disconnect patient socket if used
      if (patientSocket) { try { patientSocket.disconnect(); } catch(e){} patientSocket = null; }

      // destroy PeerJS peer if created
      if (peer) { try { peer.destroy(); } catch(e){} }
    }
/* ---------- socket.io client ---------- */
const socket = io();
const MY_USERNAME = 'DR.pragati';
const REMOTE_USERNAME = 'Hardik';
const API_BASE = ''; // adjust if needed      
socket.on("new-transcript", ({ user_id, text }) => {
    logDoctor(`New Transcript for User ${user_id}: "${text.substring(0, 40)}..."`);
});

socket.on("sos-alert", ({ user_id, location, time }) => {
    logDoctor(`ðŸš¨ðŸš¨ SOS Alert from User ${user_id} at ${new Date(time).toLocaleTimeString()}! Location: ${location}`);
});


/* ---------- Chart: simple canvas sparkline (Keep Existing Vitals/Chart Logic) ---------- */
function drawChart(){
  const c = document.getElementById('chart');
  c.width = c.offsetWidth;
  c.height = 140;
  const ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  if(chartPoints.length===0) return;
  const max = Math.max(...chartPoints,120);
  const min = Math.min(...chartPoints,40);
  ctx.beginPath();
  chartPoints.forEach((v,i)=>{
    const x = (i/(chartPoints.length-1||1))*c.width;
    const y = c.height - ((v-min)/(max-min||1))*c.height;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.lineWidth = 2;
  ctx.strokeStyle = '#1e7e34';
  ctx.stroke();
}

/* ---------- update UI with data ---------- */
function updateUI(data){
  sugarEl.textContent = data.sugar ? (data.sugar + ' mg/dL') : '-- mg/dL';
  bpEl.textContent = (data.sys ? data.sys : '--') + ' / ' + (data.dia ? data.dia : '--');
  dialEl.textContent = data.DIALYSIS ? data.DIALYSIS : 'â€”';
  lastUpdateEl.textContent = new Date().toLocaleTimeString();
  if(data.sugar) {
    chartPoints.push(data.sugar);
    if(chartPoints.length>30) chartPoints.shift();
  }
  drawChart();
}

/* ---------- poll latest readings ---------- */
async function fetchLatest(){
  try{
    const res = await fetch(API_BASE + '/api/data');
    if(!res.ok) return;
    const json = await res.json();
    latestData = json || {};
    updateUI(latestData);
  }catch(e){}
}

/* ---------- simulate device (calls backend POST to /api/data) ---------- */
document.getElementById('connect-device').addEventListener('click',()=>{
  if(simInterval) return;
  simInterval = setInterval(async ()=>{
    const fakeSugar = Math.floor(Math.random()*80)+80;
    const fakeSys = Math.floor(Math.random()*50)+110;
    const fakeDia = Math.floor(Math.random()*30)+70;
    const d = { sugar: fakeSugar, sys: fakeSys, dia: fakeDia, DIALYSIS: Math.random()>0.97 ? 'YES' : 'NO', ts: Date.now() };
    try{
      await fetch(API_BASE + '/api/data',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
    }catch(e){
      console.error('post err',e);
    }
  },3000);
  logDoctor('Device simulator STARTED');
});

document.getElementById('stop-device').addEventListener('click',()=>{
  if(simInterval){ clearInterval(simInterval); simInterval = null; logDoctor('Device simulator STOPPED'); }
});

/* Webhook simulation removed */

/* ---------- doctor console (simulated) ---------- */
function logDoctor(msg){
  const p = document.createElement('div');
  p.style.padding = '.4rem .5rem';
  p.style.borderBottom = '1px dashed rgba(0,0,0,0.04)';
  p.textContent = `[${new Date().toLocaleTimeString()} - ${MY_USERNAME}] ${msg}`;
  doctorConsole.prepend(p);
}

/* ---------- session controls ---------- */
document.getElementById('regenSession').addEventListener('click', ()=>{
  const sid = 'sid-' + Math.random().toString(36).slice(2,9);
  document.getElementById('session-id').textContent = sid;
  logDoctor('Session regenerated: ' + sid);
});

/* ---------- poller ---------- */
setInterval(fetchLatest, 3000);
fetchLatest();

/* ---------- export logs (simple) ---------- */
document.getElementById('exportLogs').addEventListener('click', ()=>{
  const text = doctorConsole.innerText;
  const blob = new Blob([text],{type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'doctor_log.txt'; a.click();
  URL.revokeObjectURL(url);
});

/* Removed webhook-related save button */


/* ---------- small init ---------- */
drawChart();
hangupBtn.disabled = true;
callBtn.disabled = true;
logDoctor(`Initialized as ${MY_USERNAME}. Connect as ${REMOTE_USERNAME} in another tab to call.`);
</script>
</body>
</html>